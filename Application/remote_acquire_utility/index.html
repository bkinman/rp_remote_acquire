<!--
 * Red Pitaya Remote acquisition utility.
 *
 * Author: Brandon Kinman <brandon@kinmantech.org>
 *         
-->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        Remote Acquire Utility
    </title>
    <link href="../assets/bootstrap-3.0.0/css/bootstrap.css" rel="stylesheet" type="text/css">
    <link href="../assets/style.css?6" rel="stylesheet" type="text/css">
    <script src="../assets/bootstrap-3.0.0/js/jquery.js" type="text/javascript">
    </script>
    <script src="../assets/bootstrap-3.0.0/js/bootstrap.min.js" type="text/javascript">
    </script>
    <script src="./assets/ipaddr/lib/ipaddr.js" type="text/javascript">
    </script>
    <script type="text/javascript">
    // Settings which can be modified
    var app_id = 'remote_acquire_utility';
    var root_url = '';
    //var root_url = 'http://10.0.1.221';      // Test local
    //var root_url = 'http://192.168.53.133';  // Test remote and local  
    //var root_url = 'http://192.168.1.100';   // Default RedPitaya IP
    var start_app_url = root_url + '/bazaar?start=' + app_id;
    var stop_app_url = root_url + '/bazaar?stop=';
    var get_url = root_url + '/data';
    var post_url = root_url + '/data';

    var request_timeout = 15000; // Milliseconds

    // Settings which should not be modified
    var downloading = false;
    var sending = false;
    var user_editing = false;
    var app_started = false;
    var last_get_failed = false;
    var datasets = [];
    var params = {
        original: null,
        local: null
    };

    //Default parameters - posted after server side app is started 
    var def_params = {
        ip_tup_a: parseInt(192),
        ip_tup_b: parseInt(168),
        ip_tup_c: parseInt(1),
        ip_tup_d: parseInt(100),
        port: parseInt(7777),
        mode: parseInt(2), //2 is Server mode
        b_use_udp: parseInt(0),
        bytes_to_transfer: parseInt(0), //0 is "unlimited"
        b_report_rate: parseInt(0),
        scope_channel: parseInt(0),
        scope_decimation: parseInt(100), //100 => 125e6/100 ~ 488kSps
        b_scope_no_equalizer: parseInt(0),
        b_scope_hv: parseInt(0),
        scope_no_shaping: parseInt(0),
        is_started: parseInt(0),
    };

    // On page loaded
    // This is shorthand for jQuery.ready(handler)
    $(function() {

        // Add application ID in the message from modal popup
        $('.app-id').text(app_id);

        // Disable all controls until the params state is loaded for the first time 
        $('input, select, button', '.container').prop('disabled', true);

        // Event binding
        // $('#port').val(params.port);
        // $('#mode').val(params.mode);
        // $('#protocol').val(params.b_use_udp);
        // $('#bytes_to_transfer').val(params.bytes_to_transfer);
        // $('#scope_channel').val(params.scope_channel);
        // $('#scope_decimation').val(params.scope_decimation);
        // $('#b_scope_no_equalizer').val(params.b_scope_no_equalizer);
        // $('#b_scope_hv').val(params.b_scope_hv);
        // $('#scope_no_shaping').val(params.scope_no_shaping);
        $('#port').on('change', function() {
            params.port = parseInt($(this).val());
        });

        $('#mode').on('change', function() {
            params.mode = parseInt($(this).val());
        });

        $('#protocol').on('change', function() {
            params.b_use_udp = parseInt($(this).val());
        });

        $('#address').on('change', function() {
            if(ipaddr.isValid($(this).val())){
                    $('#address-div').removeClass('has-error');
                    $("#address").css({"background-color": ""});
                    params.ip_tup_a = parseInt(ipaddr.parse($('#address').val()).octets[0]);
                    params.ip_tup_b = parseInt(ipaddr.parse($('#address').val()).octets[1]);
                    params.ip_tup_c = parseInt(ipaddr.parse($('#address').val()).octets[2]);
                    params.ip_tup_d = parseInt(ipaddr.parse($('#address').val()).octets[3]);
            } else {
                $('#address').val('IP Address Was Invalid!');
                $("#address").css({"background-color": "#ff99cc"});
                $('#address-div').addClass('has-error');
            }

        });

        $('#btn_set_config').on('click', function() {
            sendParams();
        });

        $('#btn_start_stop').on('click', function() {
            if($(this).hasClass('btn-success'))
            {
                //Start Remote Acquire
                params.is_started = parseInt(1);
                sendParams();
                $(this).removeClass('btn-success');
                $(this).addClass('btn-danger');
                $(this).find('span').removeClass('glyphicon-play');
                $(this).find('span').addClass('glyphicon-stop');
            }
            else
            {
                //Stop Remote Acquire
                params.is_started = parseInt(0);
                sendParams();
                $(this).removeClass('btn-danger');
                $(this).addClass('btn-success');
                $(this).find('span').removeClass('glyphicon-stop');
                $(this).find('span').addClass('glyphicon-play');
            }

        });

        // Modal popups

        $('#modal_err, #modal_app').modal({
            show: false,
            backdrop: 'static',
            keyboard: false
        });

        $('#btn_switch_app').on('click', function() {
            var newapp_id = $('#new_app_id').text();
            if (newapp_id.length) {
                location.href = location.href.replace(app_id, newapp_id);
            }
        });

        $('.btn-app-restart').on('click', function() {
            location.reload();
        });

        $('#btn_retry_get').on('click', function() {
            $('#modal_err').modal('hide');
        });

        $('.btn-close-modal').on('click', function() {
            $(this).closest('.modal').modal('hide');
        });

        // Stop the application when page is unloaded
        window.onbeforeunload = function() {
            $.ajax({
                url: stop_app_url,
                async: false
            });
        };

        startApp();

    });

    function startApp() {
        $.get(
                start_app_url
            )
            .done(function(dresult) {
                if (dresult.status == 'ERROR') {
                    showModalError((dresult.reason ? dresult.reason : 'Could not start the application.'), true);
                } else {
                    //Every time the app loads, we must get the parameters.
                    $.get(
                            get_url
                        )
                        .done(function(dresult) {
                            if (dresult.status == 'ERROR') {
                                showModalError((dresult.reason ? dresult.reason : 'Could not GET initial configuration parameters.'), true);
                            } else {
                                loadParams(dresult.datasets.params);
                                $('input, select, button', '.container').prop('disabled', false);
                            }
                        })
                        .fail(function() {
                            showModalError((dresult.reason ? dresult.reason : 'Could not GET initial configuration parameters.'), true);
                        });
                }
            })
            .fail(function() {
                showModalError('Could not start the application.', true);
            });
    }

    function showModalError(err_msg, retry_btn, restart_btn, ignore_btn) {
        var err_modal = $('#modal_err');

        err_modal.find('#btn_retry_get')[retry_btn ? 'show' : 'hide']();
        err_modal.find('.btn-app-restart')[restart_btn ? 'show' : 'hide']();
        err_modal.find('#btn_ignore')[ignore_btn ? 'show' : 'hide']();
        err_modal.find('.modal-body').html(err_msg);
        err_modal.modal('show');
    }

    function showModalNotification(msg) {
        var mod_note = $('#modal_notification');

        mod_note.find('#modal_msg').text(msg);
        mod_note.modal({ 
            "backdrop": "static",
            "keyboard": true,
            "show": true
        });
    }

    //Updates the user interface and also
    //the global params object
    function loadParams(orig_params) {
        if (!$.isPlainObject(orig_params)) {
            return;
        }
        params = $.extend({}, orig_params);

        // Same data in local and original params
        params = $.extend({}, params);

        $('#port').val(params.port);
        $('#mode').val(params.mode);
        $('#protocol').val(params.b_use_udp);
        $('#bytes_to_transfer').val(params.bytes_to_transfer);
        $('#scope_channel').val(params.scope_channel);
        $('#scope_decimation').val(params.scope_decimation);
        $('#b_scope_no_equalizer').val(params.b_scope_no_equalizer);
        $('#b_scope_hv').val(params.b_scope_hv);
        $('#scope_no_shaping').val(params.scope_no_shaping);
    }

    function isParamChanged() {
        if (params) {
            for (var key in params) {
                if (params[key] != params[key]) {
                    return true;
                }
            }
        }
        return false;
    }

    //Posts the parameters and calls loadParams
    function sendParams() {
        $.ajax({
                type: 'POST',
                url: post_url,
                data: JSON.stringify({
                    datasets: {
                        params: params
                    }
                }),
                timeout: request_timeout,
                cache: false
            })
            .done(function(dresult) {
                // OK: Load the params received as POST result
                showModalNotification('Parameters sent successfully.');
                if (dresult.datasets !== undefined && dresult.datasets.params !== undefined) {
                    loadParams(dresult.datasets.params);
                } else if (dresult.status == 'ERROR') {
                    showModalError((dresult.reason ? dresult.reason : 'Error while sending data (E1).'), false, true, true);
                } else {
                    showModalError('Error while sending data (E2).', false, true, true);
                }
            })
            .fail(function() {
                showModalError('Error while sending data (E3).', false, true, true);
            });
    }

    function getData(from, to) {
        var rangedata = new Array();
        for (var i = 0; i < datasets.length; i++) {
            if (!$('#btn_ch' + (i + 1)).data('checked')) {
                continue;
            }
            rangedata.push({
                color: datasets[i].color,
                label: datasets[i].label,
                data: []
            });
            for (var j = 0; j < datasets[i].data.length; j++) {
                if (datasets[i].data[j][0] > to) {
                    break;
                }
                if (datasets[i].data[j][0] >= from) {
                    rangedata[rangedata.length - 1].data.push(datasets[i].data[j]);
                }
            }
        }
        rangedata = filterData(rangedata, (plot ? plot.width() : $('plot_holder').width()));
        return rangedata;
    }
    </script>
    <script src="../assets/redpitaya.custom.js" type="text/javascript">
    </script>
</head>

<body>
    <div class="header">
        <div class="container">
            <a id="btn_exit" class="pull-left" href="/index.html"><span class="glyphicon glyphicon-chevron-left" title="Exit" alt="Exit"></span></a>
            <img class="logo pull-left" src="../assets/images/logo_white.png">
            <h2 class="page-title">
                    Remote Acquire Utility
                </h2>
        </div>
    </div>
    <div class="container">
        <div class="row">
            <div class="col-xs-7 col-sm-7">
            </div>
            <div class="col-xs-5 col-sm-5">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">
                                Configuration
                            </h3>
                    </div>
                    <div class="panel-body">
                        <form class="form-horizontal" role="form" onsubmit="return false;">
                            <div class="form-group">
                                <label for="protocol" class="col-xs-4 control-label">Protocol:</label>
                                <div class="col-xs-8">
                                    <select id="protocol" class="form-control">
                                        <option value="0">
                                            TCP
                                        </option>
                                        <option value="1">
                                            UDP
                                        </option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="mode" class="col-xs-4 control-label">Mode:</label>
                                <div class="col-xs-8">
                                    <select id="mode" class="form-control">
                                        <option value="2">
                                            Server
                                        </option>
                                        <option value="1">
                                            Client
                                        </option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="scope_channel" class="col-xs-4 control-label">Scope Channel:</label>
                                <div class="col-xs-8">
                                    <select id="scope_channel" class="form-control">
                                        <option value="0">
                                            A
                                        </option>
                                        <option value="1">
                                            B
                                        </option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="b_scope_no_equalizer" class="col-xs-4 control-label">EQ Filter:</label>
                                <div class="col-xs-8">
                                    <select id="b_scope_no_equalizer" class="form-control">
                                        <option value="0">
                                            Enabled
                                        </option>
                                        <option value="1">
                                            Disabled
                                        </option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="b_scope_hv" class="col-xs-4 control-label">HV EQ Settings:</label>
                                <div class="col-xs-8">
                                    <select id="b_scope_hv" class="form-control">
                                        <option value="0">
                                            Disabled
                                        </option>
                                        <option value="1">
                                            Enabled
                                        </option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="scope_no_shaping" class="col-xs-4 control-label">Shaping Filter:</label>
                                <div class="col-xs-8">
                                    <select id="scope_no_shaping" class="form-control">
                                        <option value="0">
                                            Enabled
                                        </option>
                                        <option value="1">
                                            Disabled
                                        </option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group has-feedback" id="address-div">
                                <label for="address" class="col-xs-4 control-label">IP Address:</label>
                                <div class="col-xs-8">
                                    <input type="text" class="form-control" id="address" placeholder="NA" aria-describedby="inputError2Status">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="port" class="col-xs-4 control-label">Port:</label>
                                <div class="col-xs-8">
                                    <input type="text" class="form-control" id="port" placeholder="NA">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="bytes_to_transfer" class="col-xs-4 control-label">Bytes to Xfer:</label>
                                <div class="col-xs-8">
                                    <input type="text" class="form-control" id="bytes_to_transfer" placeholder="NA">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="decimation" class="col-xs-4 control-label">Decimation:</label>
                                <div class="col-xs-8">
                                    <input type="text" class="form-control" id="decimation" placeholder="NA">
                                </div>
                            </div>
                        </form>
                        <div class="row text-center">
                            <div class="col-xs-3"></div>
                            <div class="col-xs-3">
                                <button id="btn_set_config" class="btn btn-success" disabled>Set Config</button>
                            </div>
                            <div class="col-xs-3">
                                <button id="btn_start_stop" class="btn btn-success">
                                    <span class="glyphicon glyphicon-play" aria-hidden="true"></span>
                                </button>
                            </div>
                            <div class="col-xs-3"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer clearfix">
            <p class="pull-right" style="margin: 4px 0 0">
                Â© 2014 - Brandon Kinman
            </p>
        </div>
    </div>
    <div id="modal_notification" class="modal fade">
        <div class="modal-dialog">
            <div class="modal-content">
                <!-- dialog body -->
                <div class="modal-body">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <div id="modal_msg"> Hello world!</div>
                </div>
                <!-- dialog buttons -->
                <!--
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary">OK</button>
                </div>
                -->
            </div>
        </div>
    </div>
    <div id="modal_err" class="modal" tabindex="-1" role="dialog" aria-labelledby="modal_err_label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="modal_err_label">
                            Application error
                        </h4>
                </div>
                <div class="modal-body"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default btn-close-modal" id="btn_ignore">Ignore</button>
                    <button type="button" class="btn btn-default" id="btn_retry_get">Retry</button>
                    <button type="button" class="btn btn-primary btn-app-restart">Restart</button>
                </div>
            </div>
        </div>
    </div>
    <div id="modal_app" class="modal" tabindex="-1" role="dialog" aria-labelledby="modal_app_label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="modal_app_label">
                            Application stopped
                        </h4>
                </div>
                <div class="modal-body">
                    The application was stopped. The current started application is <strong><span id="new_app_id"></span></strong>.
                    <br> Do you want to switch to newly started application or to restart ?
                </div>
                <div class="modal-footer">
                    <a href="/index.html" class="btn btn-danger pull-left">Exit app</a>
                    <button type="button" class="btn btn-default" id="btn_switch_app">Switch</button>
                    <button type="button" class="btn btn-primary btn-app-restart">Restart</button>
                </div>
            </div>
        </div>
    </div>
</body>

</html>